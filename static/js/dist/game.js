class LevelChoice{constructor(t){this.menu=t,this.$choice=$('\n        <div class="ac-game-menu">\n            <div class="ac-game-menu-field">\n                <div class="ac-game-menu-field-item ac-game-menu-field-item-single-esay">\n                    简单\n                </div>\n                <br>\n                <div class="ac-game-menu-field-item ac-game-menu-field-item-single-difficult">\n                    困难\n                </div>\n                <br>\n                <div class="ac-game-menu-field-item ac-game-menu-field-item-single-hell">\n                    噩梦\n                </div>\n                <br>\n                <div class="ac-game-menu-field-item ac-game-menu-field-item-single-back">\n                    返回\n                </div>\n            </div>\n        </div>\n        '),this.menu.root.$ac_game.append(this.$choice),this.$easy=this.$choice.find(".ac-game-menu-field-item-single-esay"),this.$difficult=this.$choice.find(".ac-game-menu-field-item-single-difficult"),this.$hell=this.$choice.find(".ac-game-menu-field-item-single-hell"),this.$back=this.$choice.find(".ac-game-menu-field-item-single-back"),this.start()}start(){this.hide(),this.add_listening_events()}add_listening_events(){let t=this;this.$easy.click((function(){t.menu.root.playground.show("single",{level:1,robot_num:15,robot_speed:1,is_track:!1})})),this.$difficult.click((function(){t.menu.root.playground.show("single",{level:2,robot_num:24,robot_speed:1.1,is_track:!0})})),this.$hell.click((function(){t.menu.root.playground.show("single",{level:2,robot_num:29,robot_speed:1.3,is_track:!0})})),this.$back.click((function(){t.hide(),t.menu.show()}))}show(){this.$choice.show()}hide(){this.$choice.hide()}}class AcGameMenu{constructor(t){this.root=t,this.$menu=$('\n        <div class="ac-game-menu">\n            <div class="ac-game-menu-field">\n                <div class="ac-game-menu-field-item ac-game-menu-field-item-single-mode">\n                    单人模式\n                </div>\n                <br>\n                <div class="ac-game-menu-field-item ac-game-menu-field-item-multi-mode">\n                    多人模式\n                </div>\n                <br>\n                <div class="ac-game-menu-field-item ac-game-menu-field-item-settings">\n                    设置\n                </div>\n                <br>\n                <div class="ac-game-menu-field-item ac-game-menu-field-item-logout">\n                    退出\n                </div>\n            </div>\n        </div>\n        '),this.root.$ac_game.append(this.$menu),this.$single_mode=this.$menu.find(".ac-game-menu-field-item-single-mode"),this.$multi_mode=this.$menu.find(".ac-game-menu-field-item-multi-mode"),this.$settings=this.$menu.find(".ac-game-menu-field-item-settings"),this.$logout=this.$menu.find(".ac-game-menu-field-item-logout"),this.choice=new LevelChoice(this),this.personalize=new Personalize(this),this.start()}start(){this.add_listening_events(),this.hide()}add_listening_events(){let t=this;this.$single_mode.click((function(){t.hide(),t.choice.show()})),this.$multi_mode.click((function(){t.hide(),t.root.playground.show("multi")})),this.$settings.click((function(){t.hide(),t.personalize.show()})),this.$logout.click((function(){$.get("/settings/logout/").then((t=>{"success"===t.result&&$(location).attr("href","/")}))}))}show(){this.$menu.show()}hide(){this.$menu.hide()}}class Personalize{constructor(t){this.menu=t,this.$panel=$('\n        <div class="game-user-info">\n            <div class="game-user-info-wrapper">\n                <img id="game-user-info-wrapper-avatar" src="" alt="">\n                <button type="button" class="btn btn-info btn-sm" id="choice">更换头像</button>\n                <div class="game-user-info-wrapper-item">\n                    <h5>用户名</h5>\n                </div>            \n                <div class="game-user-info-wrapper-item">\n                    <input id="game-user-info-wrapper-item-username" type="text" placeholder="用户名">\n                </div>\n                <div class="game-user-info-wrapper-item">\n                    <h5 id="update_pwd">修改密码</h5>\n                </div>\n                <div class="game-user-info-wrapper-update-pwd">\n                    <div class="game-user-info-wrapper-item">\n                        <h5>旧密码</h5>\n                    </div>            \n                    <div class="game-user-info-wrapper-item">\n                        <input id="game-user-info-wrapper-item-old" type="password" placeholder="旧密码">\n                    </div>\n                    <div class="game-user-info-wrapper-item">\n                        <h5>新密码</h5>\n                    </div>            \n                    <div class="game-user-info-wrapper-item">\n                        <input id="game-user-info-wrapper-item-first" type="password" placeholder="新密码">\n                    </div>\n                    <br>\n                    <div class="game-user-info-wrapper-item">\n                        <input id="game-user-info-wrapper-item-second" type="password" placeholder="再次输入密码">\n                    </div>\n                </div>\n                <button type="button" class="btn btn-info btn-sm" id="user-info-save">保存</button>\n                <h5 class="game-user-info-wrapper-back">返回</h5>\n            </div>\n            <input class="inputFile" type="file" accept="image/*" id="imgReader">\n            <div id="myModal" class="modal" tabindex="-1" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">\n                <div class="modal-dialog">\n                <div class="modal-content">\n                    <div class="modal-header">\n                    <h5 class="modal-title">选择合适的区域</h5>\n                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">\n                        <span aria-hidden="true">&times;</span>\n                    </button>\n                    </div>\n                    <div class="modal-body p-0 m-2">\n                        <img id="cropImg">\n                    </div>\n                    <div class="modal-footer">\n                    <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>\n                    <button type="button" class="btn btn-primary" id="avatar_save">确定</button>\n                    </div>\n                </div>\n                </div>\n            </div>\n        </div>\n        '),this.menu.root.$ac_game.append(this.$panel),this.$avatar=$("#game-user-info-wrapper-avatar"),this.$username=$("#game-user-info-wrapper-item-username"),this.$update_pwd=$("#update_pwd"),this.update_pwd=!1,this.$pwd_field=$(".game-user-info-wrapper-update-pwd"),this.$pwd_old=$("#game-user-info-wrapper-item-old"),this.$pwd_first=$("#game-user-info-wrapper-item-first"),this.$pwd_second=$("#game-user-info-wrapper-item-second"),this.CROPPER=null,this.hide(),this.start()}start(){this.add_listening_events()}show(){this.$panel.show(),this.$username.val(this.menu.root.settings.username),this.$avatar.attr("src",this.menu.root.settings.photo),this.$pwd_field.hide()}hide(){this.$panel.hide()}add_listening_events(){this.add_listening_avatar(),this.add_listening_save(),this.add_listening_back(),this.add_listening_update_pwd()}add_listening_update_pwd(){let t=this;this.$update_pwd.click((function(){t.update_pwd?(t.$update_pwd.text("修改密码"),t.update_pwd=!1,t.$pwd_field.fadeOut()):(t.$update_pwd.text("收起"),t.update_pwd=!0,t.$pwd_field.fadeIn())}))}add_listening_back(){let t=this;$(".game-user-info-wrapper-back").click((function(){t.hide(),t.menu.show()}))}add_listening_save(){let t=this;$("#user-info-save").click((function(){t.change_user_info()}))}add_listening_avatar(){let t=this;$("#imgReader").change((function(i){$("#myModal").modal("show");let e=new FileReader;i.target.files[0]&&(e.readAsDataURL(i.target.files[0]),e.onload=i=>{let s=e.result;document.querySelector("#cropImg").src=s;const a=document.getElementById("cropImg");t.CROPPER&&t.CROPPER.destroy(),t.CROPPER=new Cropper(a,{aspectRatio:1,viewMode:1,minContainerWidth:300,minContainerHeight:300,dragMode:"move"})})})),$("#choice").click((function(){$("#imgReader").click()})),$("#avatar_save").click((function(){t.CROPPER.getCroppedCanvas({maxWidth:500,maxHeight:500,fillColor:"#fff",imageSmoothingEnabled:!0,imageSmoothingQuality:"low"}).toBlob((i=>{let e=new FileReader;e.readAsDataURL(i),e.onload=i=>{$.post("/settings/change/avatar/",{img:i.target.result},(function(i){"success"===i.result&&(t.$avatar.attr("src",i.url),t.menu.root.settings.photo=i.url,$("#myModal").modal("hide"))}))}}))}))}change_user_info(){let t=this.verfiy_username();if(this.update_pwd){let t=this.$pwd_old.val(),i=this.verfiy_pwd();t&&i&&$.post("/settings/change/pwd/",{old_pwd:t,new_pwd:i},(function(t){alert(t.msg)}))}t!=this.menu.root.settings.username&&$.ajax({type:"POST",url:"/settings/change/username/",headers:{"X-CSRFToken":$.cookie("csrftoken")},data:{username:t},success:function(t){alert(t.msg)}})}verfiy_username(){let t=this.$username.val();return t||""}verfiy_pwd(){let t=this.$pwd_old.val(),i=this.$pwd_first.val(),e=this.$pwd_second.val();return t&&i&&i===e?i:""}}let last_timestamp,AC_GAME_OBJECTS=[];class AcGameObject{constructor(){AC_GAME_OBJECTS.push(this),this.has_called_start=!1,this.timedelta=0,this.uuid=this.create_uuid()}create_uuid(){let t="";for(let i=0;i<8;i++){t+=parseInt(Math.floor(10*Math.random()))}return t}start(){}update(){}last_update(){}on_destroy(){}destroy(){this.on_destroy();for(let t=0;t<AC_GAME_OBJECTS.length;t++)if(AC_GAME_OBJECTS[t]===this){AC_GAME_OBJECTS.splice(t,1);break}}}let AC_GAME_ANIMATION=function(t){for(let i=0;i<AC_GAME_OBJECTS.length;i++){let e=AC_GAME_OBJECTS[i];e.has_called_start?(e.timedelta=t-last_timestamp,e.update()):(e.start(),e.has_called_start=!0)}last_timestamp=t;for(let t=0;t<AC_GAME_OBJECTS.length;t++){AC_GAME_OBJECTS[t].last_update()}requestAnimationFrame(AC_GAME_ANIMATION)};requestAnimationFrame(AC_GAME_ANIMATION);class ChatField{constructor(t){this.playground=t,this.$history=$('<div class="ac-game-chat-field-history">历史记录</div>'),this.$input=$('<input type="text" class="ac-game-chat-field-input">'),this.$history.hide(),this.$input.hide(),this.func_id=null,this.is_open=!1,this.playground.$playground.append(this.$history),this.playground.$playground.append(this.$input),this.start()}start(){this.add_listening_events()}add_listening_events(){let t=this;this.$input.keydown((function(i){if(27===i.which)return t.hide_input(),!1;if(13===i.which){let i=t.playground.root.settings.username,e=t.$input.val();return e?(t.add_message(i,e,!1),t.$input.val(""),t.playground.multiplayer_socket.send_message(i,e)):t.hide_input(),!1}})),this.$history.on("contextmenu",(function(){return!1}))}add_message(t,i,e){let s=$(`<div>[${t}] : ${i}</div>`);this.$history.append(s),this.$history.scrollTop(this.$history[0].scrollHeight),this.show_history();let a=this;e&&!this.is_open&&(this.func_id&&clearTimeout(this.func_id),this.func_id=setTimeout((function(){a.hide_history(),a.func_id=null}),3e3))}show_history(){this.$history.fadeIn()}hide_history(){this.$history.fadeOut()}show_input(){this.show_history(),this.is_open=!0,this.$input.show(),this.$input.focus()}hide_input(){this.$input.hide(),this.hide_history(),this.is_open=!1,this.playground.game_map.$canvas.focus()}}class GameMap extends AcGameObject{constructor(t){super(),this.playground=t,this.$canvas=$("<canvas tabindex=0></canvas>"),this.ctx=this.$canvas[0].getContext("2d"),this.ctx.canvas.width=this.playground.width,this.ctx.canvas.height=this.playground.height,this.playground.$playground.append(this.$canvas),this.grass=new Image,this.grass.src="/static/image/map/grass.png",this.stone=new Image,this.stone.src="/static/image/map/stone2.png",this.decorate_x=[],this.decorate_y=[]}start(){this.$canvas.focus();for(let t=0;t<70;t++){let t=Math.random()*this.playground.vwidth/this.playground.scale-.15,i=Math.random()*this.playground.vheight/this.playground.scale-.15;t<0&&(t+=.2),i<0&&(i+=.2),this.decorate_x.push(t),this.decorate_y.push(i)}}resize(){this.ctx.canvas.width=this.playground.width,this.ctx.canvas.height=this.playground.height,this.ctx.fillStyle="rgba(0, 0, 0, 1)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}update(){this.render()}render(){this.ctx.fillStyle="#a5bd7a",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);let t=this.playground.scale;for(let i=0;i<50;i++){let e=this.decorate_x[i]-this.playground.cx,s=this.decorate_y[i]-this.playground.cy;this.ctx.drawImage(this.grass,e*t,s*t,.1*t,.1*t)}for(let i=50;i<70;i++){let e=this.decorate_x[i]-this.playground.cx,s=this.decorate_y[i]-this.playground.cy;this.ctx.drawImage(this.stone,e*t,s*t,.15*t,.1*t)}}}class MiniMap extends AcGameObject{constructor(t){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.players=this.playground.players}start(){}last_update(){this.render()}render(){let t=this.playground.scale,i=.2*t,e=16*i/9;this.ctx.fillStyle="rgba(0, 0, 0, 0.3)",this.ctx.fillRect(0,0,e,i);for(let s=0;s<this.players.length;s++){let a=this.players[s];if(a){let s=a.x*t,h=a.y*t;"self"===a.role?this.ctx.fillStyle="skyblue":this.ctx.fillStyle="pink",this.ctx.beginPath(),this.ctx.arc(s/this.playground.vwidth*e,h/this.playground.vheight*i,.01*t,0,2*Math.PI,!1),this.ctx.fill()}}}}class NoticeBoard extends AcGameObject{constructor(t,i){super(),this.playground=t,this.ctx=t.game_map.ctx,this.text="已就绪 0 人",this.player_cnt=i}start(){}write(t){this.text=t}last_update(){this.render()}render(){this.ctx.font="20px serif",this.ctx.fillStyle="white",this.ctx.textAlign="center","waitting"===this.playground.state?(this.ctx.fillText("正在匹配",this.playground.width/2,20),this.ctx.fillText("按ESC退出匹配",this.playground.width/2,50)):"fighting"===this.playground.state&&this.ctx.fillText(`${this.playground.players.length} / ${this.player_cnt}`,this.playground.width/2,20)}}class Particle extends AcGameObject{constructor(t,i,e,s,a,h,n,l,r){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.x=i,this.y=e,this.radius=s,this.vx=a,this.vy=h,this.color=n,this.speed=l,this.move_length=r,this.friction=.9,this.eps=.01}start(){}update(){if(this.move_length<this.eps||this.speed<this.eps)return this.destroy(),!1;let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.speed*=this.friction,this.move_length-=t,this.render()}render(){let t=this.x-this.playground.cx,i=this.y-this.playground.cy,e=this.playground.scale;this.ctx.beginPath(),this.ctx.arc(t*e,i*e,this.radius*e,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}}class Player extends AcGameObject{constructor(t,i,e,s,a,h,n,l,r){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.x=i,this.y=e,this.vx=0,this.vy=0,this.direct_x=0,this.direct_y=-1,this.skill_direct_x=0,this.skill_direct_y=-1,this.mouse_position_x=0,this.mouse_position_y=0,this.move_length=0,this.damage_x=0,this.damage_y=0,this.damage_speed=0,this.friction=.9,this.spent_time=0,this.radius=s,this.color=a,this.speed=h,this.role=n,this.eps=.01,this.hp=100,this.photo=r,this.username=l,this.accelerate=null,this.fireballs=[],this.cur_skill=null,"robot"!==this.role&&(this.img=new Image,this.img.src=this.photo),"self"===this.role&&(this.fireball_img=new Image,this.fireball_img.src="/static/image/skill/fireball.png",this.blink_img=new Image,this.blink_img.src="/static/image/skill/blink.png",this.accelerate_img=new Image,this.accelerate_img.src="/static/image/skill/accelerate.png"),this.accelerate_coldtime=0,this.blink_coldtime=0,this.fireball_coldtime=0,this.poison_spent=2,this.secure=!0}start(){"multi"===this.playground.mode&&(this.playground.player_count++,3===this.playground.player_count?(this.playground.notice_board.write("Fighting!"),this.playground.state="fighting"):this.playground.notice_board.write("已就绪 "+this.playground.player_count+" 人"));let t=this.playground.scale;if("self"===this.role)this.add_listening_events();else if("robot"===this.role){let i=Math.random()*this.playground.vwidth/t,e=Math.random()*this.playground.vheight/t;this.move_to(i,e)}}add_listening_events(){this.listen_mouse_move(),this.listen_mouse_click(),this.listen_keydown()}listen_mouse_move(){let t=this;this.playground.game_map.$canvas.mousemove((function(i){if("self"!==t.role)return!1;const e=t.ctx.canvas.getBoundingClientRect();let s=(i.clientX*window.devicePixelRatio-e.left)/t.playground.scale+t.playground.cx,a=(i.clientY*window.devicePixelRatio-e.top)/t.playground.scale+t.playground.cy;t.mouse_position_x=s,t.mouse_position_y=a,t.update_skill_direct()}))}listen_mouse_click(){let t=this;"multi"===this.playground.mode&&this.playground.chat_field.$history.mousedown((function(i){if("fighting"!==t.playground.state)return!1;const e=t.ctx.canvas.getBoundingClientRect();3===i.which&&t.update_move_target(i,e)})),this.playground.game_map.$canvas.mousedown((function(i){if("fighting"!==t.playground.state)return!1;const e=t.ctx.canvas.getBoundingClientRect();if(3===i.which)t.update_move_target(i,e);else if(1==i.which){let s=(i.clientX*window.devicePixelRatio-e.left)/t.playground.scale+t.playground.cx,a=(i.clientY*window.devicePixelRatio-e.top)/t.playground.scale+t.playground.cy;if("fireball"===t.cur_skill){let i=t.shoot_fireball(s,a);"multi"===t.playground.mode&&t.playground.multiplayer_socket.send_shoot_fireball(s,a,i.uuid),t.fireball_coldtime=1.5}t.cur_skill=null}}))}listen_keydown(){let t=this;this.playground.game_map.$canvas.keydown((function(i){if("multi"===t.playground.mode){if(13===i.which)return t.playground.chat_field.show_input(),!1;if(27===i.which)return t.playground.chat_field.hide_input(),!1}if("fighting"!==t.playground.state)return!1;if(81===i.which)return t.fireball_coldtime>t.eps||t.spent_time<3||(t.cur_skill="fireball"),!1;if(70===i.which){if(t.blink_coldtime>t.eps||t.spent_time<3)return!1;t.cur_skill="blink",t.blink_coldtime=5,"multi"===t.playground.mode&&t.playground.multiplayer_socket.send_blink(t.x,t.y,t.direct_x,t.direct_y),t.blink(t.x,t.y,t.direct_x,t.direct_y),t.cur_skill=null}else if(69===i.which){if(t.accelerate_coldtime>t.eps||t.spent_time<3)return!1;"multi"===t.playground.mode&&t.playground.multiplayer_socket.send_accelerate(),t.cur_skill="accelerate",t.start_accelerate(),t.cur_skill=null}}))}unbind_listening_events(){this.cur_skill=null,this.playground.game_map.$canvas.unbind("keydown"),this.playground.game_map.$canvas.unbind("mousedown"),this.playground.game_map.$canvas.unbind("mousemove"),"multi"===this.playground.mode&&this.playground.chat_field.$history.unbind("mousedown")}update_move_target(t,i){let e=(t.clientX*window.devicePixelRatio-i.left)/this.playground.scale+this.playground.cx,s=(t.clientY*window.devicePixelRatio-i.top)/this.playground.scale+this.playground.cy;"multi"===this.playground.mode&&this.playground.multiplayer_socket.send_move_to(this.uuid,e,s),this.click_particle(5,e,s),this.move_to(e,s)}update_skill_direct(){let t=Math.atan2(this.mouse_position_y-this.y,this.mouse_position_x-this.x);this.skill_direct_x=Math.cos(t),this.skill_direct_y=Math.sin(t)}check_poison_state(t,i){let e=this.playground.scale;if(t<this.playground.poison.bound_x||i<this.playground.poison.bound_y)return!0;let s=this.playground.vwidth/e-this.playground.poison.bound_x,a=this.playground.vheight/e-this.playground.poison.bound_y;return t>s||i>a}attacked_by_poison(){this.poison_spent>2&&("multi"===this.playground.mode&&"self"===this.role&&this.playground.multiplayer_socket.send_poison_attack(this.uuid,this.x,this.y,5,"poison"),this.poison_spent=0,this.hp-=5,this.split_particle(10),this.radius-=.0015,this.hp<0&&this.destroy())}shoot_fireball(t,i){let e=this.x,s=this.y,a=Math.atan2(i-s,t-e),h=Math.cos(a),n=Math.sin(a),l=3*this.speed,r=new FireBall(this.playground,this,e,s,.01,h,n,"orange",l,1,20);return this.fireballs.push(r),r}shoot_fireball_moblie(t,i){let e=this.x,s=this.y,a=3*this.speed,h=new FireBall(this.playground,this,e,s,.01,t,i,"orange",a,1,20);return this.fireballs.push(h),h}start_accelerate(){this.accelerate=new Accelerate(this.playground,this),this.speed*=2,this.accelerate_coldtime=7}cancel_accelerate(){this.accelerate&&(this.speed/=2,this.accelerate.destroy(),this.accelerate=null)}blink(t,i,e,s){let a=this.playground.scale,h=t+.3*e,n=i+.3*s;h+this.radius>this.playground.vwidth/a&&(h=this.playground.vwidth/a-this.radius),h-this.radius<0&&(h=this.radius),n+this.radius>this.playground.vheight/a&&(n=this.playground.vheight/a-this.radius),n-this.radius<0&&(n=this.radius),this.x=h,this.y=n}on_destroy(){for(let t=0;t<this.playground.players.length;t++){let i=this.playground.players[t];i===this&&(this.accelerate&&this.accelerate.destroy(),this.playground.players.splice(t,1),"self"===i.role&&(this.unbind_listening_events(),"fighting"===this.playground.state&&this.playground.score_board.lose()))}"fighting"===this.playground.state&&1===this.playground.players.length&&"self"===this.playground.players[0].role&&this.playground.score_board.win()}destroy_fireball(t){for(let i=0;i<this.fireballs.length;i++){let e=this.fireballs[i];if(e.uuid===t){this.fireballs.splice(i,1),e.destroy();break}}}receive_attacked(t,i,e,s,a,h){h.destroy_fireball(a),this.x=t,this.y=i,this.is_attacked(e,s)}update_coldtime(){this.fireball_coldtime-=this.timedelta/1e3,this.fireball_coldtime=Math.max(this.fireball_coldtime,0),this.blink_coldtime-=this.timedelta/1e3,this.blink_coldtime=Math.max(this.blink_coldtime,0),this.accelerate_coldtime-=this.timedelta/1e3,this.accelerate_coldtime=Math.max(this.accelerate_coldtime,0)}update_robot_attack(){if("robot"===this.role&&this.playground.level.is_track&&this.spent_time>3&&Math.random()<this.playground.level.robot_speed/300)for(let t=0;t<this.playground.players.length;t++){let i=this.playground.players[t];"self"===i.role&&this.get_dist(i.x,i.y)<1&&this.shoot_fireball(i.x,i.y)}if("robot"===this.role&&this.spent_time>3&&Math.random()<1/(15*this.playground.players.length)){let t=this.playground.players[Math.floor(Math.random()*this.playground.players.length)];if(t&&t!==this){let i=t.x+t.speed*this.vx*this.timedelta/1e3*.3,e=t.y+t.speed*this.vy*this.timedelta/1e3*.3;this.shoot_fireball(i,e)}}"robot"===this.role&&this.spent_time>3&&Math.random()<1/(15*this.playground.players.length)&&this.accelerate_coldtime<this.eps&&this.start_accelerate()}update_robot_move(){let t=this.playground.scale,i=1,e=1;do{i=Math.random()*this.playground.vwidth/t,e=Math.random()*this.playground.vheight/t}while(this.check_poison_state(i,e));if(Math.random()<this.playground.level.robot_speed/(1.5*this.playground.players.length))for(let t=0;t<this.playground.players.length;t++)"self"===this.playground.players[t].role&&(i=.9*this.playground.players[t].x,e=.9*this.playground.players[t].y);this.move_to(i,e)}update_damage_state(){let t=this.playground.scale;this.vx=this.vy=0,this.move_length=0;let i=this.damage_x*this.damage_speed*this.timedelta/1e3,e=this.damage_y*this.damage_speed*this.timedelta/1e3;this.x+i>this.radius&&this.x+i+this.radius<this.playground.vwidth/t&&(this.x+=i),this.y+e>this.radius&&this.y+e+this.radius<this.playground.vheight/t&&(this.y+=e),this.damage_speed*=this.friction}update_move(){let t=this.playground.scale;if(this.update_robot_attack(),this.damage_speed>this.eps)this.update_damage_state();else if(this.move_length<this.eps)this.move_length=0,this.vx=this.vy=0,"robot"===this.role&&this.update_robot_move();else{"robot"===this.role&&!this.secure&&Math.random()<1/60&&this.update_robot_move();let i=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+this.vx*i>this.radius&&this.x+this.vx*i+this.radius<this.playground.vwidth/t&&(this.x+=this.vx*i),this.y+this.vy*i>this.radius&&this.y+this.vy*i+this.radius<this.playground.vheight/t&&(this.y+=this.vy*i),this.move_length-=i,"self"===this.role&&this.cur_skill&&this.update_skill_direct()}}click_particle(t,i,e){for(let s=0;s<t;s++){let t=Math.max(this.radius*Math.random()*.2,.005),s=2*Math.PI*Math.random(),a=Math.cos(s),h=Math.sin(s),n=this.color,l=.2,r=.2;new Particle(this.playground,i,e,t,a,h,n,l,r)}}split_particle(t){for(let i=0;i<t+10*Math.random();i++){let t=this.x,i=this.y,e=this.radius*Math.random()*.2,s=2*Math.PI*Math.random(),a=Math.cos(s),h=Math.sin(s),n=this.color,l=5*this.speed,r=this.radius*Math.random()*5;new Particle(this.playground,t,i,e,a,h,n,l,r)}}is_attacked(t,i){if(this.split_particle(20),this.radius-=i/100*.03,this.hp-=i,this.accelerate&&this.accelerate.attack_incerse(),this.hp<=0)return this.destroy(),"self"===this.role&&"multi"===this.playground.mode&&this.playground.notice_board.write("已阵亡"),!1;this.damage_x=Math.cos(t),this.damage_y=Math.sin(t),this.damage_speed=i*this.radius*2,this.speed*=1.08}get_dist(t,i){let e=t-this.x,s=i-this.y;return Math.sqrt(e*e+s*s)}move_to(t,i){this.move_length=this.get_dist(t,i);let e=Math.atan2(i-this.y,t-this.x);this.vx=Math.cos(e),this.vy=Math.sin(e),this.direct_x=this.vx,this.direct_y=this.vy}render_fireball_icon(){let t=this.playground.scale,i=1.4,e=.9,s=.04;this.ctx.save(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(233, 171, 101, 1)",this.ctx.lineWidth=8,this.ctx.arc(i*t,e*t,s*t*.85,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.fireball_img,(i-s)*t,(e-s)*t,2*s*t,2*s*t),this.ctx.restore(),this.fireball_coldtime>0&&(this.ctx.beginPath(),this.ctx.moveTo(i*t,e*t),this.ctx.arc(i*t,e*t,s*t,0-Math.PI/2,2*Math.PI*(1-this.fireball_coldtime/1.5)-Math.PI/2,!0),this.ctx.lineTo(i*t,e*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill())}render_blink_icon(){let t=this.playground.scale,i=1.52,e=.9,s=.04;this.ctx.save(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(233, 171, 101, 1)",this.ctx.lineWidth=8,this.ctx.arc(i*t,e*t,s*t*.85,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.blink_img,(i-s)*t,(e-s)*t,2*s*t,2*s*t),this.ctx.restore(),this.blink_coldtime>0&&(this.ctx.beginPath(),this.ctx.moveTo(i*t,e*t),this.ctx.arc(i*t,e*t,s*t,0-Math.PI/2,2*Math.PI*(1-this.blink_coldtime/5)-Math.PI/2,!0),this.ctx.lineTo(i*t,e*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill())}render_accelerate_icon(){let t=this.playground.scale,i=1.64,e=.9,s=.04;this.ctx.save(),this.ctx.beginPath(),this.ctx.strokeStyle="rgba(233, 171, 101, 1)",this.ctx.lineWidth=8,this.ctx.arc(i*t,e*t,s*t*.85,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.accelerate_img,(i-s)*t,(e-s)*t,2*s*t,2*s*t),this.ctx.restore(),this.accelerate_coldtime>0&&(this.ctx.beginPath(),this.ctx.moveTo(i*t,e*t),this.ctx.arc(i*t,e*t,s*t,0-Math.PI/2,2*Math.PI*(1-this.accelerate_coldtime/7)-Math.PI/2,!0),this.ctx.lineTo(i*t,e*t),this.ctx.fillStyle="rgba(0, 0, 255, 0.6)",this.ctx.fill())}render_arrow(t){let i=0;this.move_length>this.eps&&(i=.1);let e=this.x-this.playground.cx,s=this.y-this.playground.cy,a=e+this.radius*(1.3+i)*this.direct_x,h=s+this.radius*(1.3+i)*this.direct_y,n=Math.atan2(h-s,a-e),l=n+(.2+i),r=n-(.2+i),o=Math.cos(l),d=Math.sin(l),c=Math.cos(r),u=Math.sin(r),g=e+1.2*this.radius*o,p=s+1.2*this.radius*d,_=e+1.2*this.radius*c,m=s+1.2*this.radius*u;this.ctx.moveTo(a*t,h*t),this.ctx.lineTo(g*t,p*t),this.ctx.moveTo(a*t,h*t),this.ctx.lineTo(_*t,m*t),this.ctx.strokeStyle="rgba(255, 255, 255, 0.5)",this.ctx.lineJoin="round",this.ctx.stroke()}render_skill_direct(t){let i=this.x-this.playground.cx,e=this.y-this.playground.cy,s=i+this.skill_direct_x,a=e+this.skill_direct_y;this.ctx.lineWidth=8,this.ctx.moveTo(i*t,e*t),this.ctx.lineTo(s*t,a*t),this.ctx.stroke(),this.ctx.lineWidth=2}render(){let t=this.playground.scale,i=this.x-this.playground.cx,e=this.y-this.playground.cy;"robot"!==this.role?(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i*t,e*t,this.radius*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.img,(i-this.radius)*t,(e-this.radius)*t,2*this.radius*t,2*this.radius*t),this.ctx.restore()):(this.ctx.beginPath(),this.ctx.arc(i*t,e*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()),"self"===this.role&&this.cur_skill&&"fighting"===this.playground.state&&this.render_skill_direct(t),this.render_arrow(t)}render_hp(){let t=this.playground.scale,i=1.52,e=.8;this.ctx.font=.04*t+"px serif",this.ctx.fillStyle="pink",this.ctx.textAlign="center",this.ctx.fillText(`❤ HP : ${this.hp}`,i*t,e*t),this.ctx.font="20px serif",this.ctx.fillStyle="white",this.ctx.fillText("F",i*t,(e+.05)*t),this.ctx.fillText("Q",1.4*t,(e+.05)*t),this.ctx.fillText("E",(i+.12)*t,(e+.05)*t)}render_secure_notice(){this.ctx.font="20px serif",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.fillText(`${Math.floor(4-this.spent_time)} 秒后开始战斗`,this.playground.width/2,50)}last_update(){"self"===this.role&&"fighting"===this.playground.state&&(this.render_fireball_icon(),this.render_blink_icon(),this.render_accelerate_icon(),this.render_hp(),this.secure&&this.render_secure_notice())}update(){"fighting"===this.playground.state&&(this.spent_time+=this.timedelta/1e3,this.poison_spent+=this.timedelta/1e3),this.spent_time<3&&this.secure?this.speed=.5:this.spent_time>3&&this.secure&&("robot"===this.role?this.speed=.2*this.playground.level.robot_speed:this.speed=.2,this.secure=!1),this.check_poison_state(this.x,this.y)&&this.attacked_by_poison(),"self"===this.role&&this.playground.re_calculate_cx_cy(this.x,this.y),this.update_coldtime(),this.update_move(),this.render()}}class PoisonRange extends AcGameObject{constructor(t){super(),this.playground=t,this.ctx=t.game_map.ctx,this.shrink=-10,this.bound_x=0,this.bound_y=0}start(){}last_update(){"fighting"===this.playground.state&&(this.shrink+=this.timedelta/1e3),this.shrink>0&&(this.render(),this.render_poison())}render_poison(){let t=this.playground.scale,i=0-this.playground.cx,e=0-this.playground.cy;this.ctx.fillStyle="rgba(101,94,140, 0.3)",this.ctx.fillRect(i*t,e*t,this.playground.vwidth,this.bound_y*t),e=this.playground.vheight/t-this.bound_y-this.playground.cy,this.ctx.fillRect(i*t,e*t,this.playground.vwidth,this.bound_y*t),e=this.bound_y-this.playground.cy;let s=this.playground.vheight/t-2*this.bound_y;this.ctx.fillRect(i*t,e*t,this.bound_x*t,s*t),i=this.playground.vwidth/t-this.bound_x-this.playground.cx,this.ctx.fillRect(i*t,e*t,this.bound_x*t,s*t)}render(){let t=this.playground.scale;this.bound_x=this.shrink*this.playground.vwidth/360/t,this.bound_y=this.shrink*this.playground.vheight/360/t,this.bound_x=Math.min(this.bound_x,(this.playground.vwidth/2-.3*t*16/9)/t),this.bound_y=Math.min(this.bound_y,(this.playground.vheight/2-.3*t)/t);let i=this.bound_x-this.playground.cx,e=this.bound_y-this.playground.cy,s=this.playground.vwidth-2*this.bound_x*t,a=this.playground.vheight-2*this.bound_y*t;this.ctx.strokeStyle="rgba(215,212,240, 1)",this.ctx.lineWidth=5,this.ctx.strokeRect(i*t,e*t,s,a),this.ctx.lineWidth=2}}class ScoreBoard extends AcGameObject{constructor(t){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.state=null}start(){}win(){if(this.state)return;this.state="win";let t=this;setTimeout((function(){t.add_listening_events()}),1e3)}lose(){if(this.state)return;this.state="lose";let t=this;setTimeout((function(){t.add_listening_events()}),1e3)}add_listening_events(){let t=this;this.playground.game_map.$canvas.on("click",(function(){t.playground.hide(),t.playground.root.menu.show()}))}render(){let t=this.playground.height;this.ctx.fillStyle="white",this.ctx.font=.2*t+"px serif",this.ctx.textAlign="center","win"===this.state?(this.ctx.fillText("You Win !",this.playground.width/2,this.playground.height/2),this.ctx.font=.05*t+"px serif",this.ctx.fillText("click any position to quit.",this.playground.width/2,this.playground.height/2+.1*t)):"lose"===this.state&&(this.ctx.fillText("You Lose !",this.playground.width/2,this.playground.height/2),this.ctx.font=.05*t+"px serif",this.ctx.fillText("click any position to quit.",this.playground.width/2,this.playground.height/2+.1*t))}last_update(){this.render()}}class Accelerate extends AcGameObject{constructor(t,i){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.player=i,this.span=3,this.attack_cnt=0}start(){}attack_incerse(){this.attack_cnt++}update(){this.render(),this.span-=this.timedelta/1e3,this.span<this.player.eps&&this.player.cancel_accelerate()}on_desttory(){this.ctx.lineWidth=2,this.strokeStyle="white"}render(){let t=this.playground.scale,i=this.player.x-this.playground.cx,e=this.player.y-this.playground.cy;this.ctx.beginPath(),this.ctx.strokeStyle="skyblue",this.ctx.lineWidth=5,this.ctx.arc(i*t,e*t,this.player.radius*t*1.5,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.lineWidth=2,this.strokeStyle="white"}}class FireBall extends AcGameObject{constructor(t,i,e,s,a,h,n,l,r,o,d){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.player=i,this.x=e,this.y=s,this.vx=h,this.vy=n,this.color="#ff4702",this.speed=r,this.radius=a,this.move_length=o,this.damage=d,this.eps=.01}start(){}on_destroy(){let t=this.player.fireballs;for(let i=0;i<t.length;i++)if(t[i]===this){t.splice(i,1);break}}update(){if(this.move_length<this.eps)return this.destroy(),!1;this.update_move(),"enemy"!==this.player.role&&this.update_attack(),this.render()}update_move(){let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}update_attack(){for(let t=0;t<this.playground.players.length;t++){let i=this.playground.players[t];if(i!==this.player&&this.is_collision(i)){this.attack(i);break}}}attack(t){let i=Math.atan2(t.y-this.y,t.x-this.x);"multi"===this.playground.mode&&this.playground.multiplayer_socket.send_attack(t.uuid,t.x,t.y,i,this.damage,this.uuid,"fireball"),t.is_attacked(i,this.damage),this.destroy()}get_dist(t,i,e,s){let a=t-e,h=i-s;return Math.sqrt(a*a+h*h)}is_collision(t){return this.get_dist(this.x,this.y,t.x,t.y)<this.radius+t.radius}render(){let t=this.x-this.playground.cx,i=this.y-this.playground.cy,e=this.playground.scale;this.ctx.beginPath(),this.ctx.arc(t*e,i*e,this.radius*e,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill()}}class MultiPlayerSocket{constructor(t,i){this.playground=t,this.uuid=i,this.ws=new WebSocket("wss://app122.acapp.acwing.com.cn/wss/multiplayer/"),this.start()}start(){this.listening_events()}listening_events(){this.on_open(),this.on_receive()}on_open(){let t=this;this.ws.onopen=function(){t.send_create_player(t.uuid,t.playground.root.settings.username,t.playground.root.settings.photo)}}on_receive(){let t=this;this.ws.onmessage=function(i){let e=JSON.parse(i.data),s=e.uuid;if(s===t.uuid)return!1;let a=e.event;"create_player"===a?t.receive_create_player(s,e.username,e.photo):"move_to"===a?t.receive_move_to(s,e.tx,e.ty):"shoot_fireball"===a?t.receive_shoot_fireball(s,e.tx,e.ty,e.ball_uuid):"attack"===a?t.receive_attack(s,e.attackee_uuid,e.x,e.y,e.angle,e.damage,e.ball_uuid):"blink"===a?t.receive_blink(s,e.x,e.y,e.vx,e.vy):"message"===a?t.receive_message(e.username,e.text):"accelerate"===a?t.receive_accelerate(s):"poison_attack"===a&&t.receive_poison_attack(e.attackee_uuid,e.x,e.y,e.damage)}}get_player(t){let i=this.playground.players;for(let e=0;e<i.length;e++){let s=i[e];if(s.uuid===t)return s}return null}send_poison_attack(t,i,e,s,a){this.ws.send(JSON.stringify({event:"poison_attack",uuid:this.uuid,attackee_uuid:t,x:i,y:e,damage:s,type:a}))}receive_poison_attack(t,i,e,s){let a=this.get_player(t);a&&(a.x=i,a.y=e,s>100&&(a.hp-=s),a.attacked_by_poison())}send_accelerate(){this.ws.send(JSON.stringify({event:"accelerate",uuid:this.uuid}))}receive_accelerate(t){let i=this.get_player(t);i&&i.start_accelerate()}send_message(t,i){this.ws.send(JSON.stringify({event:"message",uuid:this.uuid,username:t,text:i}))}receive_message(t,i){this.playground.chat_field.add_message(t,i,!0)}send_blink(t,i,e,s){this.ws.send(JSON.stringify({event:"blink",uuid:this.uuid,x:t,y:i,vx:e,vy:s}))}receive_blink(t,i,e,s,a){let h=this.get_player(t);h&&h.blink(i,e,s,a)}send_attack(t,i,e,s,a,h,n){this.ws.send(JSON.stringify({event:"attack",uuid:this.uuid,attackee_uuid:t,x:i,y:e,angle:s,damage:a,ball_uuid:h,type:n}))}receive_attack(t,i,e,s,a,h,n){let l=this.get_player(t),r=this.get_player(i);r&&l&&r.receive_attacked(e,s,a,h,n,l)}send_shoot_fireball(t,i,e,s){this.ws.send(JSON.stringify({event:"shoot_fireball",uuid:this.uuid,tx:t,ty:i,ball_uuid:e,type:s}))}receive_shoot_fireball(t,i,e,s){let a=this.get_player(t);if(a){a.shoot_fireball(i,e).uuid=s}}receive_move_to(t,i,e){let s=this.get_player(t);s&&s.move_to(i,e)}send_move_to(t,i,e){this.ws.send(JSON.stringify({event:"move_to",uuid:t,tx:i,ty:e}))}send_create_player(t,i,e){let s={event:"create_player",uuid:t,username:i,photo:e};this.ws.send(JSON.stringify(s))}receive_create_player(t,i,e){let s=new Player(this.playground,this.playground.vwidth/2/this.playground.scale,this.playground.vheight/2/this.playground.scale,.05,"white",.2,"enemy",i,e);s.uuid=t,this.playground.players.push(s)}}class AcGamePlayground{constructor(t){this.root=t,this.$playground=$('<div class="ac-game-playground"></div>'),this.root.$ac_game.append(this.$playground),this.level,this.n=2,this.start()}get_random_color(){return["skyblue","yellow","pink","grey","green","snow","purple"][Math.floor(5*Math.random())]}start(){this.$playground.hide();let t=this;$(window).resize((function(){t.resize()}))}re_calculate_cx_cy(t,i){this.cx=t-.5*this.width/this.scale,this.cy=i-.5*this.height/this.scale,this.cy<0&&(this.cy=0),this.cy>1&&(this.cy=1),this.cx<0&&(this.cx=0),this.cx>1.77&&(this.cx=1.77)}resize(){this.width=this.$playground.width(),this.height=this.$playground.height();let t=Math.min(this.width/16,this.height/9);this.width=16*t,this.height=9*t,this.vheight=this.n*this.height,this.vwidth=this.n*this.width,this.scale=this.height,this.game_map&&this.game_map.resize()}show(t,i){if(this.level=i,this.$playground.show(),this.width=this.$playground.width(),this.height=this.$playground.height(),this.resize(),this.game_map=new GameMap(this),this.poison=new PoisonRange(this),this.score_board=new ScoreBoard(this),this.players=[],this.state="waitting",this.players.push(new Player(this,this.vwidth/2/this.scale,this.vheight/2/this.scale,.05*this.height/this.scale,"white",.2*this.height/this.scale,"self",this.root.settings.username,this.root.settings.photo)),this.re_calculate_cx_cy(this.players[0].x,this.players[0].y),"single"===t){this.mode="single",this.state="fighting";for(let t=0;t<i.robot_num;t++)this.players.push(new Player(this,.5*this.vwidth/this.scale,.5*this.vheight/this.scale,.05*this.height/this.scale,this.get_random_color(),.2*this.height/this.scale*i.robot_speed,"robot",null,null));this.notice_board=new NoticeBoard(this,this.players.length)}else"multi"===t&&(this.notice_board=new NoticeBoard(this,3),this.chat_field=new ChatField(this),this.player_count=0,this.mode="multi",this.multiplayer_socket=new MultiPlayerSocket(this,this.players[0].uuid));this.minii_map=new MiniMap(this)}hide(){for(;this.players&&this.players.length>0;)this.players[0].destroy();this.game_map&&(this.game_map.destroy(),this.game_map=null),this.notice_board&&(this.notice_board.destroy(),this.notice_board=null),this.score_board&&(this.score_board.destroy(),this.score_board=null),this.$playground.empty(),this.$playground.hide()}}class Settings{constructor(t){this.root=t,this.platform="WEB",this.root.AcWingOS&&(this.platform="ACAPP"),this.username="",this.photo="",this.$settings=$('\n<div class="ac-game-settings">\n    <div class="ac-game-settings-login">\n        <div class="ac-game-settings-title">\n            登录\n        </div>\n        <div class="ac-game-settings-username">\n            <div class="ac-game-settings-item">\n                <input type="text" placeholder="用户名">\n            </div>\n        </div>\n        <div class="ac-game-settings-password">\n            <div class="ac-game-settings-item">\n                <input type="password" placeholder="密码">\n            </div>\n        </div>\n        <div class="ac-game-settings-submit">\n            <div class="ac-game-settings-item">\n                <button>登录</button>\n            </div>\n        </div>\n        <div class="ac-game-settings-error-message">\n        </div>\n        <div class="ac-game-settings-option">\n            注册\n        </div>\n        <br>\n    </div>\n    <div class="ac-game-settings-register">\n        <div class="ac-game-settings-title">\n            注册\n        </div>\n        <div class="ac-game-settings-username">\n            <div class="ac-game-settings-item">\n                <input type="text" placeholder="用户名">\n            </div>\n        </div>\n        <div class="ac-game-settings-password ac-game-settings-password-first">\n            <div class="ac-game-settings-item">\n                <input type="password" placeholder="密码">\n            </div>\n        </div>\n        <div class="ac-game-settings-password ac-game-settings-password-second">\n            <div class="ac-game-settings-item">\n                <input type="password" placeholder="确认密码">\n            </div>\n        </div>\n        <div class="ac-game-settings-submit">\n            <div class="ac-game-settings-item">\n                <button>注册</button>\n            </div>\n        </div>\n        <div class="ac-game-settings-error-message">\n        </div>\n        <div class="ac-game-settings-option">\n            登录\n        </div>\n        <br>\n        <div class="ac-game-settings-acwing">\n            <img width="30" src="https://app165.acapp.acwing.com.cn/static/image/settings/acwing_logo.png">\n            <br>\n            <div>\n                AcWing一键登录\n            </div>\n        </div>\n    </div>\n</div>\n'),this.$login=this.$settings.find(".ac-game-settings-login"),this.$login_username=this.$login.find(".ac-game-settings-username input"),this.$login_password=this.$login.find(".ac-game-settings-password input"),this.$login_submit=this.$login.find(".ac-game-settings-submit button"),this.$login_error_message=this.$login.find(".ac-game-settings-error-message"),this.$login_register=this.$login.find(".ac-game-settings-option"),this.$acwing_login=this.$settings.find(".ac-game-settings-acwing img"),this.$login.hide(),this.$register=this.$settings.find(".ac-game-settings-register"),this.$register_username=this.$register.find(".ac-game-settings-username input"),this.$register_password=this.$register.find(".ac-game-settings-password-first input"),this.$register_password_confirm=this.$register.find(".ac-game-settings-password-second input"),this.$register_submit=this.$register.find(".ac-game-settings-submit button"),this.$register_error_message=this.$register.find(".ac-game-settings-error-message"),this.$register_login=this.$register.find(".ac-game-settings-option"),this.$register.hide(),this.root.$ac_game.append(this.$settings),this.start()}start(){"ACAPP"!=this.platform?(this.add_listening_events(),this.getUserInfo()):this.getUserInfo_AcApp()}acapp_login(t,i,e,s){let a=this;this.root.AcWingOS.api.oauth2.authorize(t,i,e,s,(function(t){"success"===t.result&&(a.username=t.username,a.photo=t.photo,a.hide(),a.root.menu.show())}))}getUserInfo_AcApp(){let t=this;$.ajax({url:"/settings/acwing/acapp/apply_code/",type:"GET",success:function(i){"success"===i.result&&t.acapp_login(i.appid,i.redirect_uri,i.scope,i.state)}})}add_listening_events(){this.add_listening_events_login(),this.add_listening_events_register(),this.add_listening_events_acwing_login()}add_listening_events_acwing_login(){let t=this;this.$acwing_login.click((function(){t.acwing_login()}))}add_listening_events_login(){let t=this;this.$login_register.click((function(){t.register()})),this.$login_submit.click((function(){t.login_on_remote()}))}add_listening_events_register(){let t=this;this.$register_login.click((function(){t.login()})),this.$register_submit.click((function(){t.register_on_remote()}))}acwing_login(){$.ajax({url:"/settings/acwing/web/apply_code/",type:"GET",success:t=>{$(location).attr("href",t.apply_code_url)}})}register_on_remote(){let t=this,i=this.$register_username.val(),e=this.$register_password.val(),s=this.$register_password_confirm.val();this.$register_error_message.empty(),$.ajax({url:"/settings/register/",type:"POST",data:{username:i,password:e,password_confirm:s},success:function(i){"success"===i.result?location.reload():t.$register_error_message.html(i.msg)}})}login_on_remote(){let t=this,i=this.$login_username.val(),e=this.$login_password.val();this.$login_error_message.empty(),$.ajax({url:"/settings/login",type:"GET",data:{username:i,password:e},success:function(i){"success"===i.result?location.reload():t.$login_error_message.html(i.result)}})}register(){this.$login.hide(),this.$register.show()}login(){this.$register.hide(),this.$login.show()}getUserInfo(){let t=this;$.ajax({url:"/settings/getUserInfo",type:"GET",data:{platform:t.platform},success:i=>{"success"===i.result?(t.username=i.username,t.photo=i.photo,t.hide(),t.root.menu.show()):t.login()}})}hide(){this.$settings.hide()}show(){this.$settings.show()}}export class AcGame{constructor(t){this.id=t,this.$ac_game=$("#"+t),document.body.style.zoom=1/window.devicePixelRatio,this.settings=new Settings(this),this.menu=new AcGameMenu(this),this.playground=new AcGamePlayground(this),this.start()}start(){$(window).on("contextmenu",(function(){return!1}))}}
